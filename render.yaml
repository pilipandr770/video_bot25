services:
  # Flask Web Application
  - type: web
    name: ai-video-bot-web
    runtime: python
    region: oregon
    plan: standard
    branch: main
    buildCommand: pip install -r requirements.txt
    startCommand: gunicorn main:app --bind 0.0.0.0:$PORT --workers 2 --timeout 300
    envVars:
      - key: TELEGRAM_BOT_TOKEN
        sync: false
      - key: TELEGRAM_WEBHOOK_URL
        sync: false
      - key: OPENAI_API_KEY
        sync: false
      - key: OPENAI_ASSISTANT_ID
        sync: false
      - key: RUNWAY_API_KEY
        sync: false
      - key: REDIS_URL
        fromService:
          type: redis
          name: ai-video-redis
          property: connectionString
      - key: TEMP_DIR
        value: /app/temp
      - key: MAX_CONCURRENT_JOBS
        value: 5
      - key: FILE_CLEANUP_HOURS
        value: 1
      - key: FFMPEG_PATH
        value: /app/bin/ffmpeg/ffmpeg
      - key: FFPROBE_PATH
        value: /app/bin/ffmpeg/ffprobe
    disk:
      name: web-temp-storage
      mountPath: /app/temp
      sizeGB: 10
    autoDeploy: true

  # Celery Worker
  - type: worker
    name: ai-video-bot-worker
    runtime: python
    region: oregon
    plan: standard
    branch: main
    buildCommand: pip install -r requirements.txt
    startCommand: celery -A app.tasks worker --loglevel=info --concurrency=2
    envVars:
      - key: OPENAI_API_KEY
        sync: false
      - key: OPENAI_ASSISTANT_ID
        sync: false
      - key: RUNWAY_API_KEY
        sync: false
      - key: REDIS_URL
        fromService:
          type: redis
          name: ai-video-redis
          property: connectionString
      - key: TEMP_DIR
        value: /app/temp
      - key: MAX_CONCURRENT_JOBS
        value: 5
      - key: FILE_CLEANUP_HOURS
        value: 1
      - key: FFMPEG_PATH
        value: /app/bin/ffmpeg/ffmpeg
      - key: FFPROBE_PATH
        value: /app/bin/ffmpeg/ffprobe
    disk:
      name: worker-temp-storage
      mountPath: /app/temp
      sizeGB: 20
    autoDeploy: true

  # Redis Service
  - type: redis
    name: ai-video-redis
    region: oregon
    plan: starter
    maxmemoryPolicy: allkeys-lru
    ipAllowList: []
