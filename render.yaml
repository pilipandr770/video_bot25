services:
  # Flask Web Application
  - type: web
    name: ai-video-bot-web
    runtime: docker
    region: frankfurt
    plan: starter
    branch: main
    dockerfilePath: ./Dockerfile
    dockerContext: .
    envVars:
      - key: TELEGRAM_BOT_TOKEN
        sync: false
      - key: TELEGRAM_WEBHOOK_URL
        sync: false
      - key: OPENAI_API_KEY
        sync: false
      - key: OPENAI_ASSISTANT_ID
        sync: false
      - key: RUNWAY_API_KEY
        sync: false
      - key: REDIS_URL
        fromService:
          type: redis
          name: ai-video-redis
          property: connectionString
      - key: TEMP_DIR
        value: /app/temp
      - key: MAX_CONCURRENT_JOBS
        value: 5
      - key: FILE_CLEANUP_HOURS
        value: 1
      - key: FFMPEG_PATH
        value: ffmpeg
      - key: FFPROBE_PATH
        value: ffprobe
      - key: LOG_LEVEL
        value: INFO
    disk:
      name: web-temp-storage
      mountPath: /app/temp
      sizeGB: 10
    autoDeploy: true

  # Celery Worker
  - type: worker
    name: ai-video-bot-worker
    runtime: docker
    region: frankfurt
    plan: starter
    branch: main
    dockerfilePath: ./Dockerfile
    dockerContext: .
    dockerCommand: celery -A app.tasks worker --loglevel=info --concurrency=2
    envVars:
      - key: OPENAI_API_KEY
        sync: false
      - key: OPENAI_ASSISTANT_ID
        sync: false
      - key: RUNWAY_API_KEY
        sync: false
      - key: REDIS_URL
        fromService:
          type: redis
          name: ai-video-redis
          property: connectionString
      - key: TEMP_DIR
        value: /app/temp
      - key: MAX_CONCURRENT_JOBS
        value: 5
      - key: FILE_CLEANUP_HOURS
        value: 1
      - key: FFMPEG_PATH
        value: ffmpeg
      - key: FFPROBE_PATH
        value: ffprobe
      - key: LOG_LEVEL
        value: INFO
    disk:
      name: worker-temp-storage
      mountPath: /app/temp
      sizeGB: 20
    autoDeploy: true

  # Redis Service (for Celery and rate limiting)
  - type: redis
    name: ai-video-redis
    region: frankfurt
    plan: starter
    maxmemoryPolicy: allkeys-lru
    ipAllowList: []

  # PostgreSQL Database (optional - for job history and user data)
  # Uncomment if you want to use PostgreSQL
  # - type: pserv
  #   name: ai-video-postgres
  #   region: frankfurt
  #   plan: starter
  #   databaseName: ai_video_bot
  #   databaseUser: ai_video_bot_user
  #   ipAllowList: []
