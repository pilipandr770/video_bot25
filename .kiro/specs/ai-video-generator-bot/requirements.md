# Документ Требований

## Введение

Система автоматической генерации рекламных видеороликов представляет собой Flask веб-приложение, развернутое на Render.com, которое взаимодействует с пользователями через Telegram бота. Система принимает текстовое или голосовое описание темы рекламного ролика и автоматически генерирует готовое 4-минутное видео с озвучкой, используя OpenAI API для создания сценария, изображений, анимаций и аудио, а также FFmpeg для сборки финального видео.

## Глоссарий

- **Telegram Bot**: Интерфейс системы для взаимодействия с пользователями через мессенджер Telegram
- **Flask Application**: Веб-приложение на Python, обрабатывающее запросы и управляющее процессом генерации видео
- **Render.com**: Облачная платформа для развертывания веб-приложений
- **OpenAI Assistant**: AI-модель с предустановленными инструкциями (Assistant ID) для генерации сценариев
- **Runway API**: AI-сервис для генерации изображений и их анимации в видео
- **OpenAI TTS**: Сервис преобразования текста в речь
- **FFmpeg**: Инструмент для обработки и сборки видео и аудио файлов
- **Video Segment**: 5-секундный фрагмент видео, соответствующий одной части сценария
- **Final Video**: Готовый 4-минутный рекламный ролик с озвучкой

## Требования

### Требование 1

**User Story:** Как пользователь, я хочу отправить текстовое описание темы рекламного ролика боту, чтобы получить готовое видео без необходимости самостоятельного создания контента

#### Критерии Приемки

1. WHEN пользователь отправляет текстовое сообщение в Telegram Bot, THE Telegram Bot SHALL принять сообщение и подтвердить начало обработки
2. THE Flask Application SHALL валидировать, что входящее сообщение является текстовым типом
3. THE Flask Application SHALL принимать текстовые сообщения любой длины для максимальной детализации
4. THE Flask Application SHALL передать текстовое описание в OpenAI Assistant для генерации сценария

### Требование 2

**User Story:** Как пользователь, я хочу отправить голосовое сообщение с описанием темы ролика, чтобы быстро создать запрос без набора текста

#### Критерии Приемки

1. WHEN пользователь отправляет голосовое сообщение в Telegram Bot, THE Telegram Bot SHALL принять аудиофайл и подтвердить начало обработки
2. THE Flask Application SHALL валидировать, что входящее сообщение является голосовым типом
3. THE Flask Application SHALL загрузить голосовое сообщение из Telegram API
4. THE Flask Application SHALL преобразовать голосовое сообщение в текст с использованием OpenAI Whisper API
5. THE Flask Application SHALL принимать распознанный текст любой длины для максимальной детализации
6. THE Flask Application SHALL передать распознанный текст в OpenAI Assistant для генерации сценария

### Требование 3

**User Story:** Как пользователь, я хочу получить профессионально написанный сценарий для 4-минутного ролика, чтобы видео было структурированным и качественным

#### Критерии Приемки

1. THE Flask Application SHALL отправить описание темы в OpenAI Assistant с предустановленным Assistant ID для генерации сценария
2. THE OpenAI Assistant SHALL создать сценарий для 4-минутного видео согласно инструкциям в Assistant ID
3. THE Flask Application SHALL разделить полученный сценарий на сегменты по 5 секунд каждый (всего 48 сегментов)
4. THE Flask Application SHALL сохранить каждый сегмент сценария с временной меткой и порядковым номером
5. IF OpenAI Assistant возвращает ошибку, THEN THE Flask Application SHALL повторить запрос до 3 раз с экспоненциальной задержкой

### Требование 3A

**User Story:** Как пользователь, я хочу утвердить сценарий перед началом генерации видео, чтобы убедиться, что содержание соответствует моим ожиданиям

#### Критерии Приемки

1. WHEN сценарий сгенерирован, THE Telegram Bot SHALL отправить полный текст сценария пользователю
2. THE Telegram Bot SHALL отобразить inline кнопки "✅ Утвердить" и "❌ Отменить"
3. WHEN пользователь нажимает "✅ Утвердить", THE Flask Application SHALL продолжить генерацию видео
4. WHEN пользователь нажимает "❌ Отменить", THE Flask Application SHALL остановить задачу и очистить временные файлы
5. IF пользователь не отвечает в течение 10 минут, THEN THE Flask Application SHALL автоматически отменить задачу

### Требование 4

**User Story:** Как пользователь, я хочу, чтобы для каждой части сценария было создано соответствующее изображение, чтобы визуальный ряд соответствовал содержанию

#### Критерии Приемки

1. THE Flask Application SHALL генерировать текстовый промпт для создания изображения для каждого Video Segment
2. THE Flask Application SHALL отправить каждый промпт в Runway API для генерации изображения
3. THE Flask Application SHALL ожидать завершения генерации изображения через Runway API (polling или webhook)
4. THE Flask Application SHALL загрузить сгенерированное изображение и сохранить его локально с уникальным идентификатором
5. THE Flask Application SHALL связать каждое изображение с соответствующим Video Segment
6. WHILE генерация изображений выполняется, THE Telegram Bot SHALL отправлять пользователю обновления о прогрессе каждые 10 сегментов
7. IF генерация изображения через Runway API завершается ошибкой, THEN THE Flask Application SHALL повторить запрос до 2 раз перед уведомлением пользователя об ошибке

### Требование 4A

**User Story:** Как пользователь, я хочу просмотреть и утвердить сгенерированные изображения перед их анимацией, чтобы убедиться в качестве визуального ряда

#### Критерии Приемки

1. WHEN все изображения сгенерированы, THE Telegram Bot SHALL отправить пользователю галерею из первых 5 изображений как превью
2. THE Telegram Bot SHALL отобразить inline кнопки "✅ Утвердить изображения" и "❌ Отменить"
3. WHEN пользователь нажимает "✅ Утвердить изображения", THE Flask Application SHALL продолжить анимацию
4. WHEN пользователь нажимает "❌ Отменить", THE Flask Application SHALL остановить задачу и очистить временные файлы
5. IF пользователь не отвечает в течение 10 минут, THEN THE Flask Application SHALL автоматически отменить задачу

### Требование 5

**User Story:** Как пользователь, я хочу, чтобы статические изображения были анимированы, чтобы видео выглядело динамично и профессионально

#### Критерии Приемки

1. THE Flask Application SHALL генерировать промпт для анимации каждого сгенерированного изображения
2. THE Flask Application SHALL отправить изображение и промпт анимации в Runway API для создания 5-секундного видео
3. THE Flask Application SHALL ожидать завершения анимации через Runway API (polling или webhook)
4. THE Flask Application SHALL загрузить анимированное видео и сохранить его локально с уникальным идентификатором
5. THE Flask Application SHALL связать каждое анимированное видео с соответствующим Video Segment
6. WHILE анимация выполняется, THE Telegram Bot SHALL отправлять пользователю обновления о прогрессе каждые 10 сегментов
7. IF анимация через Runway API завершается ошибкой, THEN THE Flask Application SHALL повторить запрос до 2 раз перед уведомлением пользователя об ошибке

### Требование 5A

**User Story:** Как пользователь, я хочу просмотреть и утвердить анимированные видео перед финальной сборкой, чтобы убедиться в качестве результата

#### Критерии Приемки

1. WHEN все видео сегменты анимированы, THE Telegram Bot SHALL отправить пользователю первые 3 видео сегмента как превью
2. THE Telegram Bot SHALL отобразить inline кнопки "✅ Утвердить видео" и "❌ Отменить"
3. WHEN пользователь нажимает "✅ Утвердить видео", THE Flask Application SHALL продолжить генерацию аудио и финальную сборку
4. WHEN пользователь нажимает "❌ Отменить", THE Flask Application SHALL остановить задачу и очистить временные файлы
5. IF пользователь не отвечает в течение 10 минут, THEN THE Flask Application SHALL автоматически отменить задачу

### Требование 6

**User Story:** Как пользователь, я хочу, чтобы видео имело профессиональную озвучку, чтобы ролик был готов к использованию без дополнительной обработки

#### Критерии Приемки

1. THE Flask Application SHALL объединить все сегменты сценария в единый текст для озвучки
2. THE Flask Application SHALL отправить текст сценария в OpenAI TTS API для генерации аудиодорожки
3. THE OpenAI TTS SHALL создать аудиофайл длительностью приблизительно 4 минуты
4. THE Flask Application SHALL загрузить и сохранить аудиофайл локально
5. THE Flask Application SHALL синхронизировать длительность аудио с общей длительностью видео (48 сегментов × 5 секунд = 240 секунд)

### Требование 7

**User Story:** Как пользователь, я хочу получить единое готовое видео, чтобы не заниматься сборкой отдельных частей самостоятельно

#### Критерии Приемки

1. THE Flask Application SHALL использовать FFmpeg для объединения всех Video Segment в последовательное видео
2. THE FFmpeg SHALL добавить сгенерированную аудиодорожку к объединенному видео
3. THE FFmpeg SHALL синхронизировать аудио и видео дорожки
4. THE Flask Application SHALL создать Final Video в формате MP4 с разрешением не менее 1080p
5. THE Flask Application SHALL оптимизировать размер Final Video для отправки через Telegram (максимум 50 МБ)

### Требование 8

**User Story:** Как пользователь, я хочу получить готовое видео непосредственно в Telegram, чтобы сразу использовать или поделиться им

#### Критерии Приемки

1. WHEN Final Video готово, THE Flask Application SHALL загрузить видеофайл через Telegram Bot API
2. THE Telegram Bot SHALL отправить Final Video пользователю в чат
3. IF размер Final Video превышает лимит Telegram (50 МБ), THEN THE Flask Application SHALL сжать видео с сохранением приемлемого качества
4. THE Telegram Bot SHALL отправить пользователю уведомление об успешном завершении генерации
5. THE Flask Application SHALL удалить временные файлы (изображения, видео сегменты, аудио) после успешной отправки

### Требование 9

**User Story:** Как пользователь, я хочу получать информацию о статусе обработки моего запроса, чтобы понимать, сколько времени займет генерация видео

#### Критерии Приемки

1. WHEN Flask Application начинает обработку запроса, THE Telegram Bot SHALL отправить пользователю сообщение с оценкой времени выполнения
2. WHILE обработка выполняется, THE Telegram Bot SHALL отправлять обновления статуса на ключевых этапах (генерация сценария, создание видео через Runway, генерация озвучки, сборка финального видео)
3. THE Telegram Bot SHALL отображать процент выполнения для длительных операций (генерация видео через Runway API)
4. IF обработка занимает более 5 минут, THEN THE Telegram Bot SHALL отправлять промежуточные сообщения каждые 2 минуты
5. THE Telegram Bot SHALL отправить финальное уведомление с общим временем генерации после завершения

### Требование 10

**User Story:** Как пользователь, я хочу получать понятные сообщения об ошибках, чтобы понимать, что пошло не так и как исправить проблему

#### Критерии Приемки

1. IF любой этап обработки завершается ошибкой, THEN THE Flask Application SHALL логировать детали ошибки
2. THE Telegram Bot SHALL отправить пользователю понятное сообщение об ошибке без технических деталей
3. THE Telegram Bot SHALL предложить пользователю повторить попытку или изменить запрос
4. IF ошибка связана с OpenAI API (лимиты, недоступность), THEN THE Telegram Bot SHALL информировать пользователя о временной недоступности сервиса
5. THE Flask Application SHALL очистить временные файлы даже в случае ошибки

### Требование 11

**User Story:** Как администратор системы, я хочу, чтобы приложение было развернуто на Render.com и интегрировано с GitHub, чтобы обеспечить автоматическое развертывание и масштабируемость

#### Критерии Приемки

1. THE Flask Application SHALL быть развернуто на Render.com как веб-сервис
2. THE Flask Application SHALL автоматически развертываться при push в основную ветку GitHub репозитория
3. THE Flask Application SHALL включать FFmpeg в образ развертывания
4. THE Flask Application SHALL использовать переменные окружения для хранения API ключей (OpenAI, Telegram Bot Token)
5. THE Flask Application SHALL логировать все операции для мониторинга и отладки

### Требование 12

**User Story:** Как администратор системы, я хочу, чтобы приложение эффективно управляло ресурсами, чтобы минимизировать затраты и обеспечить стабильную работу

#### Критерии Приемки

1. THE Flask Application SHALL использовать временное хранилище для промежуточных файлов
2. THE Flask Application SHALL удалять временные файлы после завершения обработки или через 1 час после создания
3. THE Flask Application SHALL ограничивать количество одновременных запросов до 5 для предотвращения перегрузки
4. IF количество запросов превышает лимит, THEN THE Telegram Bot SHALL информировать пользователя о необходимости подождать
5. THE Flask Application SHALL использовать асинхронную обработку для длительных операций
